# =============================================================================
# WORKFLOW GITHUB ACTIONS - CI/CD FRONTEND ANGULAR
# DÃ©ploiement automatique sur AWS S3 + CloudFront avec Terraform
# =============================================================================

name: ğŸš€ Deploy Frontend to AWS

# DÃ©clencheurs du workflow
on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permet l'exÃ©cution manuelle

# Variables d'environnement globales
env:
  NODE_VERSION: '20'
  TERRAFORM_VERSION: '1.12.1'
  AWS_REGION: 'eu-west-3'
  WORKING_DIRECTORY: './terraform/frontend'

# DÃ©finition des jobs
jobs:
  # =============================================================================
  # JOB 1: BUILD DE L'APPLICATION ANGULAR
  # =============================================================================
  build:
    name: ğŸ”¨ Build Angular Application
    runs-on: ubuntu-latest
    
    steps:
      # Checkout du code source
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      # Configuration de Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      # Installation des dÃ©pendances
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      # Build de l'application Angular en mode production
      - name: ğŸ—ï¸ Build Angular Application
        run: npm run build
        
      # Upload des artefacts de build
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: angular-build
          path: dist/vibe-ticket-frontend/
          retention-days: 1

  # =============================================================================
  # JOB 2: DÃ‰PLOIEMENT DE L'INFRASTRUCTURE TERRAFORM
  # =============================================================================
  deploy-infrastructure:
    name: ğŸ—ï¸ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build
    
    # Permissions pour l'Ã©criture dans le repository (pour l'Ã©tat Terraform)
    permissions:
      contents: write
      
    outputs:
      bucket-name: ${{ steps.terraform-output.outputs.bucket-name }}
      cloudfront-distribution-id: ${{ steps.terraform-output.outputs.cloudfront-distribution-id }}
    
    steps:
      # Checkout du code source
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      # Debug des secrets (sans afficher les valeurs)
      - name: ğŸ” Debug Secrets
        run: |
          echo "VÃ©rification des secrets AWS..."
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âŒ AWS_ACCESS_KEY_ID est vide ou manquant"
            exit 1
          else
            echo "âœ… AWS_ACCESS_KEY_ID est configurÃ©"
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âŒ AWS_SECRET_ACCESS_KEY est vide ou manquant"
            exit 1
          else
            echo "âœ… AWS_SECRET_ACCESS_KEY est configurÃ©"
          fi
        
      # Configuration d'AWS CLI
      - name: âš™ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      # Test de connexion AWS
      - name: ğŸ”— Test AWS Connection
        run: |
          echo "Test de connexion AWS..."
          aws sts get-caller-identity
          
      # Installation de Terraform
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
          
      # Initialisation de Terraform
      - name: ğŸš€ Terraform Init
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: terraform init
        
      # Validation de la configuration Terraform
      - name: âœ… Terraform Validate
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: terraform validate
        
      # Plan Terraform (pour information)
      - name: ğŸ“‹ Terraform Plan
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: terraform plan -no-color
        
      # Application de Terraform
      - name: ğŸš€ Terraform Apply
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: terraform apply -auto-approve -no-color
        
      # RÃ©cupÃ©ration des outputs Terraform
      - name: ğŸ“Š Get Terraform Outputs
        id: terraform-output
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "bucket-name=$(terraform output -raw bucket_name)" >> $GITHUB_OUTPUT
          echo "cloudfront-distribution-id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT
          
      # Commit de l'Ã©tat Terraform mis Ã  jour
      - name: ğŸ’¾ Commit Terraform State
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # VÃ©rifier s'il y a des changements dans les fichiers d'Ã©tat
          if [ -f "terraform/frontend/terraform.tfstate" ]; then
            git add terraform/frontend/terraform.tfstate
          fi
          if [ -f "terraform/frontend/terraform.tfstate.backup" ]; then
            git add terraform/frontend/terraform.tfstate.backup
          fi
          
          # Commit seulement s'il y a des changements
          if git diff --staged --quiet; then
            echo "Aucun changement d'Ã©tat Terraform Ã  committer"
          else
            git commit -m "ğŸ¤– Update Terraform state after deployment [skip ci]"
            git push
          fi

  # =============================================================================
  # JOB 3: DÃ‰PLOIEMENT DE L'APPLICATION SUR S3
  # =============================================================================
  deploy-application:
    name: ğŸŒ Deploy Application to S3
    runs-on: ubuntu-latest
    needs: [build, deploy-infrastructure]
    
    steps:
      # Checkout du code source
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      # Configuration d'AWS CLI
      - name: âš™ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      # TÃ©lÃ©chargement des artefacts de build
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: angular-build
          path: dist/vibe-ticket-frontend/
          
      # Synchronisation avec S3
      - name: ğŸ”„ Sync to S3
        run: |
          aws s3 sync dist/vibe-ticket-frontend/ s3://${{ needs.deploy-infrastructure.outputs.bucket-name }}/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "*.json"
          
          # Upload des fichiers HTML avec un cache plus court
          aws s3 sync dist/vibe-ticket-frontend/ s3://${{ needs.deploy-infrastructure.outputs.bucket-name }}/ \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "*.html" \
            --include "*.json"
            
      # Invalidation du cache CloudFront
      - name: ğŸ”„ Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.deploy-infrastructure.outputs.cloudfront-distribution-id }} \
            --paths "/*"
            
      # Affichage des URLs de dÃ©ploiement
      - name: ğŸ‰ Deployment Summary
        run: |
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
          echo "ğŸŒ Application dÃ©ployÃ©e sur:"
          echo "   - S3: http://${{ needs.deploy-infrastructure.outputs.bucket-name }}.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
          echo "   - CloudFront: RÃ©cupÃ©ration de l'URL en cours..."
          
      # RÃ©cupÃ©ration et affichage de l'URL CloudFront
      - name: ğŸ”— Get CloudFront URL
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          # Installation de Terraform pour rÃ©cupÃ©rer les outputs
          curl -fsSL https://releases.hashicorp.com/terraform/${{ env.TERRAFORM_VERSION }}/terraform_${{ env.TERRAFORM_VERSION }}_linux_amd64.zip -o terraform.zip
          unzip terraform.zip
          sudo mv terraform /usr/local/bin/
          
          # Initialisation et rÃ©cupÃ©ration des outputs
          terraform init
          CLOUDFRONT_URL=$(terraform output -raw cloudfront_url_http)
          echo "ğŸš€ URL CloudFront: $CLOUDFRONT_URL"
          echo "ğŸ“± Votre application Vibe-ticket est maintenant accessible !"
